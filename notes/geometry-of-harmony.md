# 和声的几何学：数学驱动的规则引擎 + 交互式作曲

> 日期：2026-02-10
> 背景：Experiment 001 之后的思考。我们发现 LLM 擅长"选什么和弦"，但"怎么排列声部"需要规则引擎。这篇文档探索一个方向：**如果规则引擎本身就是数学/几何引擎，会怎样？**

---

## 1. 核心洞察：音乐理论的大部分规则都是几何约束

### 和弦 = 向量

一个 n 声部的和弦就是 $\mathbb{Z}^n$ 空间里的一个点。

```
C 大三和弦某个 voicing:  [48, 64, 67, 72]  →  四维空间中的一个坐标
G 属七某个 voicing:      [47, 62, 65, 71]  →  四维空间中的另一个坐标
```

### Voice leading = 位移向量

从一个和弦走到下一个和弦，就是加一个位移向量 $d = v_2 - v_1$。

```
v1 = [48, 64, 67, 72]
v2 = [47, 62, 65, 71]
d  = [-1, -2, -2, -1]   ← 每条声部移动了多少半音
```

**好的 voice leading = 位移向量的 norm 小。** 巴赫的天才之一：在和声空间里走最短路径。

### 所有传统规则都是向量约束

| 规则 | 数学表达 |
|------|----------|
| **平行五度** | $d_i = d_j$ 且 $(v_{1,j} - v_{1,i}) \mod 12 = 7$ |
| **平行八度** | $d_i = d_j$ 且 $(v_{1,j} - v_{1,i}) \mod 12 = 0$ |
| **声部交叉** | 存在 $i < j$ 使得 $v_{2,i} > v_{2,j}$ |
| **最小移动** | $\min \|d\|_1$ 或 $\min \|d\|_2$ |
| **导音解决** | 若 $v_{1,i} \mod 12 = 11$（B in C major），则 $d_i = +1$ |
| **七音下行** | 若 $v_{1,i}$ 是和弦七音，则 $d_i < 0$ |
| **间距限制** | $v_{2,j} - v_{2,i} \leq 12$ 对相邻上声部 |

不需要 if-else 规则库，不需要 music21 的 200KB 模块——**纯 numpy 运算。**

---

## 2. Tymoczko 的音乐几何学

Princeton 的 Dmitri Tymoczko 在 *A Geometry of Music* (2011) 中提出：

### 和弦空间是 Orbifold

所有 n 声部和弦构成一个 n 维空间，但有两个对称性需要考虑：

1. **八度等价**：C3 ≈ C4 ≈ C5 → pitch 空间是圆环 $\mathbb{R}/12\mathbb{Z}$
2. **声部可交换**：[C, E, G] = [E, G, C] → 坐标对称群 $S_n$

取这两个商之后，空间变成 **orbifold**（一种带边界和锥点的流形）。

- 二声部和弦 → Möbius strip（莫比乌斯带）
- 三声部和弦 → 三维 orbifold，长得像一个有棱角的面包
- 四声部和弦 → 四维，无法直接可视化但可以投影

### Voice leading = 空间中的路径

一首曲子的和声进行就是在这个空间里的一条路径。

- **巴赫**：路径紧凑、高效，每一步移动很小，但覆盖丰富的区域
- **摇滚/流行**：路径倾向于在少数几个点之间反复跳——I, IV, V, vi 的小循环
- **爵士**：路径沿着 circle of fifths 旋转，大量 ii-V-I
- **Pink Floyd**：路径偶尔大胆跳到远处，然后慢慢飘回来

**不同风格在几何空间里有不同的"签名"——这就是为什么这个视角对我们的融合实验有用。**

---

## 3. Tonnetz：最经典的和声可视化

Tonnetz 是一个 2D 晶格，编码了音高之间的三种基本关系：

```
      E ——— B ——— F#——— C#
     / \   / \   / \   / \
    /   \ /   \ /   \ /   \
   C ——— G ——— D ——— A ——— E
    \   / \   / \   / \   /
     \ /   \ /   \ /   \ /
      Ab——— Eb——— Bb——— F
     / \   / \   / \   / \
    /   \ /   \ /   \ /   \
   E ——— B ——— F#——— C#
```

- **横轴**：纯五度（C→G→D→A...）
- **右上斜轴**：大三度（C→E→G#...）
- **右下斜轴**：小三度（C→Eb→Gb...）
- **三角形**：每个上三角 = 大三和弦，每个下三角 = 小三和弦

### 在 Tonnetz 上"看"和声进行

- **C → Am**（I → vi）：相邻三角形，共享两个音（C 和 E），只有一个音变（G→A）——这就是为什么它听起来很"近"
- **C → F**（I → IV）：也是相邻三角形，共享 C 和 F... wait, 共享 C。一个音变。
- **C → F#dim**：三角形距离远，听觉上也"远"——常用于制造紧张感

### Tonnetz 的数学本质

Tonnetz 实际上是 $\mathbb{Z}/12\mathbb{Z}$ 上的一个 lattice，由两个生成元定义：
- 纯五度 = +7 (mod 12)
- 大三度 = +4 (mod 12)

因此它是 $\mathbb{Z}^2$ 对 $12\mathbb{Z}$ 的商——一个 torus（甜甜圈）表面。和弦的"距离"就是这个 torus 上的测地线距离。

---

## 4. 对 Prelude Zero 的意义

### 4.1 规则引擎升级：从"规则检查"到"几何优化"

当前问题：voicing 产生平行五度/八度。
当前方案：先生成 voicing，再用 music21 检查——是 reactive 的。

**新方案**：把 voicing 选择建模为带约束的最优化问题。

```
输入：
  - 当前和弦向量 v1
  - 下一个和弦的 pitch class set (从 Roman numeral 得来)
  - 约束条件（无平行五度/八度、无交叉、间距合理）

输出：
  - 最优 voicing v2，使得 ||v2 - v1|| 最小

方法：
  - 枚举所有合法 voicing（有限集合，通常 < 100 种）
  - 过滤掉违反约束的
  - 选 norm 最小的
```

这是一个小型离散优化，brute-force 就够，甚至不需要 LP solver。

### 4.2 风格签名：用几何描述不同音乐风格

如果把一首曲子的和声进行画在 Tonnetz 或和弦空间里，不同风格会有明显不同的几何特征：

- **巴赫 BWV 846**：紧凑的路径，围绕 C 大调的 T-SD-D 功能区做小范围运动，偶尔短暂偏离再回来
- **Pink Floyd**：更大的跳跃，可能用到 Tonnetz 上相隔较远的和弦（比如 I → bVI → bVII 这种平行大调借用）
- **华语流行 Royal Road**：IV→V→iii→vi 在 Tonnetz 上是一个很特定的四步路径

**融合 = 设计一条新路径，具有多种风格的几何特征。**

### 4.3 交互式作曲：在几何空间里"画"音乐

**设想的 UI**：

```
┌─────────────────────────────────────────────────────┐
│                   Tonnetz View                       │
│                                                      │
│      E ——— B ——— F#                                 │
│     / \   / \   / \                                  │
│    C ——[G]——— D ——— A      ← 当前和弦高亮           │
│     \   / \   / \   /                                │
│      Ab——— Eb——— Bb                                  │
│                                                      │
│  [绿色] = 1步可达，voice leading 代价低              │
│  [黄色] = 可达但代价中等                              │
│  [灰色] = 代价高（大跳跃）                            │
│                                                      │
├─────────────────────────────────────────────────────┤
│  Timeline:  |I  |vi7|IV |V7 |I  |...               │
│             ▼                                        │
│  [播放] [导出 MIDI]                                  │
└─────────────────────────────────────────────────────┘
```

用户可以：
1. **点击 Tonnetz 上的三角形**选择下一个和弦 → 系统自动找最优 voicing
2. **画一条路径**（比如"我想从这里走到那里"）→ 系统生成最优的和弦序列
3. **叠加风格模板**：显示"巴赫常走的路径"和"Pink Floyd 常走的路径"作为参考线
4. **实时听到变化**：每次选择立即渲染为音频

### 4.4 更远的可能性

- **3D 可视化**：用 Three.js 渲染三声部/四声部的 orbifold 空间，路径在空间中飞行
- **风格插值**：在"巴赫路径"和"Pink Floyd 路径"之间做线性插值，看中间地带是什么
- **张力曲线可视化**：路径远离 tonic 区域 = 紧张感增加，回到 tonic = 释放。可以在时间轴上画出这个曲线。
- **多首歌对比**：在同一个 Tonnetz 上叠加多条路径，看到不同作品的和声"指纹"

---

## 5. 实施路径（渐进式）

### 现在就可以做
- 用 numpy 向量重写 voicing 引擎（替代 music21 的 VoiceLeadingQuartet）
- 实现带约束的最优 voicing 搜索

### 第二步
- 实现 Tonnetz 坐标映射（pitch class → 2D 坐标）
- 把 BWV 846 的和声进行画在 Tonnetz 上（静态可视化，先用 matplotlib）
- 对比 Claude 生成的进行 vs 原曲的几何特征

### 第三步（等 Pink Floyd 阶段）
- 分析 Pink Floyd 的和声在 Tonnetz 上的分布
- 设计"融合路径"——巴赫的局部连接性 + Pink Floyd 的远距离跳跃

### 更远（产品形态探索阶段）
- 交互式 Tonnetz UI（React + D3 或 Three.js）
- "在几何空间里画音乐"的交互模式

---

## 6. 参考

- Dmitri Tymoczko, *A Geometry of Music* (Oxford, 2011)
- Euler 最早提出 Tonnetz (1739)
- Neo-Riemannian theory: David Lewin, *Generalized Musical Intervals and Transformations* (1987)
- Tonnetz 的现代数学处理：Amiot, *Music Through Fourier Space* (2016)
- ekzhang/harmony (GitHub): 用 dynamic programming 做 voice leading 优化
